<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>QR復号ツール</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#2196f3">
  <link rel="manifest" href="manifest.json">
  <script src="core.js"></script>
  <script src="sha256.js"></script>
  <script src="aes.js"></script>
  <script src="enc-base64.js"></script>
  <script src="html5-qrcode.min.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("Service Worker registered"))
        .catch(err => console.error("Service Worker registration failed:", err));
    }
  </script>
  <style>
    body { font-family: sans-serif; padding: 1em; background: #f5f5f5; }
    #reader { width: 300px; margin-bottom: 1em; }
    #result { white-space: pre-wrap; margin-top: 1em; background: #fff; padding: 1em; border-radius: 8px; }
    input, button { margin-top: 0.5em; padding: 0.5em; font-size: 1em; }
  </style>
</head>
<body>
  <h2>QRコード復号ツール</h2>
  <div id="reader"></div>
  <input type="password" id="password" placeholder="パスワードを入力">
  <button onclick="decrypt()">復号する</button>
  <div id="result">QRコードを読み取ってください。</div>

  <script>
    let encryptedText = "";

    const qr = new Html5Qrcode("reader");
    qr.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
      (decodedText) => {
        encryptedText = decodedText;
        document.getElementById("result").textContent = "読み取り成功。パスワードを入力して復号してください。";
        qr.stop();
      },
      (errorMessage) => {}
    );

    function decrypt() {
      const password = document.getElementById("password").value;
      try {
        const data = window.Base64Parser.parse(encryptedText);
        const iv = data.iv;
        const ciphertext = data.ciphertext;
        const key = window.HashFunction(password);
        const decrypted = window.AESDecrypt(ciphertext, key, iv);
        const plainText = decrypted.toString(window.Utf8);
        document.getElementById("result").textContent = plainText || "復号に失敗しました。パスワードが正しいか確認してください。";
      } catch (e) {
        document.getElementById("result").textContent = "復号エラー：" + e.message;
      }
    }

    // ライブラリの関数を抽象化（CryptoJSという名前を隠す）
    window.Base64Parser = {
      parse: function (b64) {
        const raw = CryptoJS.enc.Base64.parse(b64);
        return {
          iv: CryptoJS.lib.WordArray.create(raw.words.slice(0, 4)),
          ciphertext: CryptoJS.lib.WordArray.create(raw.words.slice(4))
        };
      }
    };

    window.HashFunction = function (text) {
      return CryptoJS.SHA256(text);
    };

    window.AESDecrypt = function (ciphertext, key, iv) {
      return CryptoJS.AES.decrypt({ ciphertext }, key, { iv });
    };

    window.Utf8 = CryptoJS.enc.Utf8;
  </script>
</body>
</html>
